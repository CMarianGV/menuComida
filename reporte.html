<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="./css/app.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Grand+Hotel" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Amatic+SC:400,700|Josefin+Slab:400,600,700" rel="stylesheet">
    <title>Reporte</title>
</head>

<body class="portada">
    <div class=miContainer>
      <!-----------------------------Menú del restaurante--------------------------->
      <ul id="menuDesayuno" class="dropdown-content">
  			<li><a href="./desayuno/desayunoEntrada.html">Entrada</a></li>
  			<li class="divider"></li>
  			<li><a href="./desayuno/desayunoFuerte.html">Plato fuerte</a></li>
  			<li class="divider"></li>
  			<li><a href="./desayuno/desayunoPostre.html">Postre</a></li>
  		</ul>

  		<ul id="menuComida" class="dropdown-content">
  			<li><a href="./comida/comidaEntrada.html">Entrada</a></li>
  			<li class="divider"></li>
  			<li><a href="./comida/comidaFuerte.html">Plato fuerte</a></li>
  			<li class="divider"></li>
  			<li><a href="./comida/comidaPostre.html">Postre</a></li>
  		</ul>

  		<ul id="menuCena" class="dropdown-content">
  			<li><a href="./cena/cenaEntrada.html">Entrada</a></li>
  			<li class="divider"></li>
  			<li><a href="./cena/cenaFuerte.html">Plato fuerte</a></li>
  			<li class="divider"></li>
  			<li><a href="./cena/cenaPostre.html">Postre</a></li>
  		</ul>

  		<ul id="menuBebidas" class="dropdown-content">
  			<li><a href="./bebida/bebidaFria.html">Bebidas frias</a></li>
  			<li class="divider"></li>
  			<li><a href="./bebida/bebidaCaliente.html">Bebidas calientes</a></li>
  			<li class="divider"></li>
  			<li><a href="./bebida/bebidaAlcohol.html">Bebidas alcoholicas</a></li>
  		</ul>

      <nav class="teal"><!--Etiqueta para la barra de la vegación la clase ayuda al diseño-->
    	  <div class="nav-wrapper "><!--clases que nos ayudan en el diseño-->
    	  <!--Etiqueta para el logo del restaurante con un href que nos llevara a la pagina
    				principal de la aplicación-->
    	    <a href="index.html" class="brand-logo hide-on-small-only"> Gondola Restaurant </a>
    	    <a href="index.html" data-activates="mobile-demo" class="button-collapse ">Gondola Restaurant</a>
    	    <div class="row">
    	    	<!--Etiqueta que nos permite diseñar una lista con una clase que nos ayuda al diseño responsivo que indica que esta lista se va a ocultar cuando llegue a una versión de tabelet o telefono y mediante la etiqueta del logo del restaurante aparecera otro tipo de menú-->
    	    	<ul class="right hide-on-med-and-down">

    				<li><a class="dropdown-button" data-activates="menuDesayuno">Desayunos</a></li>
    				<li><a class="dropdown-button" data-activates="menuComida">Comidas</a></li>
    				<li><a class="dropdown-button" data-activates="menuCena">Cenas</a></li>
    				<li><a class="dropdown-button" data-activates="menuBebidas">Bebidas</a></li>
    				<li><a class="dropdown-button" href="./pedido.html">Pedidos</a></li>
    				<li><a class="dropdown-button" href="./comentarios.html">Comentarios</a></li>
            <li><a class="dropdown-button" href="https://chat-4292c.firebaseapp.com">Chat</a></li>
    				<li><a class="dropdown-button" href="./contacto.html">Contacto</a></li>
    				<li><a class="dropdown-button" href="./reporte.html">Info</a></li>

    	    	</ul>
    	    	<ul class="side-nav" id="mobile-demo">
    		        <li><a class="dropdown-button" data-activates="menuDesayunoMovil">Desayunos</a></li>
    		        <li><a class="dropdown-button" data-activates="menuComidaMovil" >Comidas</a></li>
    		        <li><a class="dropdown-button" data-activates="menuCenaMovil" >Cenas</a></li>
    		        <li><a class="dropdown-button" data-activates="menuBebidasMovil" >Bebidas</a></li>
    		        <li><a class="dropdown-button" href="./pedido.html">Pedidos</a></li>
    						<li><a class="dropdown-button" href="./comentarios.html">Comentarios</a></li>
                <li><a class="dropdown-button" href="https://chat-4292c.firebaseapp.com">Chat</a></li>
    						<li><a class="dropdown-button" href="./contacto.html">Contacto</a></li>
    						<li><a class="dropdown-button" href="./reporte.html">Info</a></li>
    		    </ul>
    	    </div>
    	  </div>
    	</nav>

      <!---------------------Portada del tecnológico--------------------------------------->
      <div class="row">
        <div class="teal darken-4 col l12 m12 s12" id="h1">
          <div class="row hide-on-med-and-down">
            <div class="col l3 m3">
              <img src="./images/Portada/SEP_LOGO.png" class="responsive-img">
            </div>
              <div class="col l7 m7">
                <div class="col l12 m12">
                  <h3 class="grey-text text-lighten-2 center" id="t">TECNOLÓGICO NACIONAL DE MÉXICO </h4>
                </div>
                <div class="col l12 m12">
                  <h4 class="grey-text text-lighten-2 center" id="t">INSTITUTO TECNOLÓGICO DE CUAUTLA</h6>
                </div>
              </div>
              <div class="col l2 m2">
                <img src="./images/Portada/ITC_LOGO1.png" class="responsive-img">
             </div>
          </div>
            <div class="row hide-on-large-only">
            <div class="col s8">
              <h6 class="grey-text text-lighten-2 center" id="t">TECNM</h6>
              <h6 class="grey-text text-lighten-2 center" id="t">ITC</h6>
            </div>
            <div class="col s4">
              <img src="./images/Portada/ITC_LOGO1.png" class="responsive-img">
            </div>
          </div>
        </div>
      </div>

      <!------------------------------Inicio del Reporte--------------------------------->
      <div class="row" id="trans">
        <h3 class="white-text center">Sección de comentarios</h3>
        <h3 class="center white-text">Visual</h3>
        <div class="col l6 m6 s6">
          <h3 class="center white-text">Inicio chat</h3>
          <img src="./images/reporte/chat1.png" class="responsive-img">
        </div>
        <div class="col l6 m12 s12" >
          <h3 class="center white-text">Ventana Admin</h3>
          <img src="./images/reporte/chat2.png" class="responsive-img">
        </div>
        <div class="col l6 m6 s6">
          <h3 class="center white-text">Login con gmail</h3>
          <img src="./images/reporte/chat3.png" class="responsive-img">
        </div>
        <div class="col l6 m12 s12" >
          <h3 class="center white-text">Ventana User</h3>
          <img src="./images/reporte/chat4.png" class="responsive-img">
        </div>

        <div class="col l6 m12 s12">
          <h3 class="center white-text">Codigo HTML</h3>
          <h3 class="center white-text">Componente principal</h3>
          <pre class="language-markup">
&ltdiv class="miContainer">
	&ltapp-navbar>&lt/app-navbar>
  &ltdiv class="right-align" *ngIf="!administrador && !_ls.user">
   &lt!--Con el metodo click en esta etiqueta estamos indicando que al presionar el boton
   tendra que hacer una llamada a la función loginAdministrador() para poder visualizar
   la ventana del administrador que es en la cual va a poder responder los mensajes-->
  	&lta class="waves-effect waves-light btn-large red darken-4" (click)="loginAdministrador()">Administrador&lt/a>
  &lt/div>
  &lt!--En este contenerdor estamos indicando que se tiene que cumplir la condicional que en este caso
  se a un usuario el que la utilice, para mostrar cierto tipo de contenido-->
  &ltng-container *ngIf="!_ls.user">
  	&ltdiv class="container-column">
  		&lth1 class="white-text">Ingresa y dejanos saber tus dudas&lt/h1>
  		&lt!--Por medio del metodo click estamos haciendo un llamado a la función login, la cual nos
  		nos va a permitir logearnos por medio de nuestra cuenta de gmail-->
  		&lta class="waves-effect waves-light btn-large red darken-4" (click)="login()">Login&lt/a>
  	&lt/div>
  &lt/ng-container>

  &ltng-container *ngIf="_ls.user">
  	&ltdiv class="container-column">
      &lt!--En esta parte estamos indicando que por medio del llamado a la función logout vamos a
      cerrar la sesión del usuario que este dejando su mensaje-->
    	&lta class="waves-effect waves-light btn-large red darken-4" (click)="logout()">Logout&lt/a>
      &ltdiv class="chat-window animated fadeIn fast">
  			&lth3 class="white-text center">Chatea con nosotros&lt/h3>
  				&lt!--Esta directiva nos permite lograr que por medio de componentes, puedas ir fraccionando
  				proyecto en este caso, con la etiqueta app-chat estamos indicando que en esa seccion de la
  			  pagina va a estar contenido la sección de los mensajes y por medio de otro componente se
  				realizara toda la visulización y estructura del chat-->
  				&ltapp-chat>&lt/app-chat>
  		&lt/div>
  	&lt/div>
  &lt/ng-container>
&lt/div>
          </pre>
          <h3 class="center white-text">Componente del chat</h3>
          <pre class="language-markup">
&ltdiv class="miContainer">
&lt!--ng-container es un contenedor que es utilizado en angular y ngIf es una directiva
 que nos permite visualizar cierto tipo de contenido dependiendo si se cumple la condicional o no
en este caso que _ls.user sea igual a administrador-->
&ltng-container *ngIf="_ls.user=='administrador'">
	&ltdiv class="listado-chats grey lighten-1 center">
		&ltspan class="red-text text-darken-4" id="hola">Mensajes Recibidos&lt/span>
		&lt!--ngFor es una directiva ciclica que nos va a ayudar a obtener cada uno de los chats personalizados
		con el pip async estamos indicando que solo queremos los mensajes sin codigo basura -->
		&ltdiv *ngFor="let chat of _ls.chats | async">
			&lt!--Aqui estamos indicando que cada chat lo va a mostrar en un boton con el nombre de la persona
			que te envio el mensaje y al hacerle click va a visualizar el administrador el chat de esa persona
	  	la parte del |JSON estamos indicando que no lo queremos en un archivo .json si no solo el valor
			y al hacer click va a mandar a llamar al metodo consultar-->
		&lta (click)="consultar(chat.uid)" class="waves-effect waves-light btn-large red white-text" id="cambios">Responder a {{chat.nombre |json}}&lt/a>
		&lt/div>
	&lt/div>
&lt/ng-container>

&ltdiv class="container-chat">
	&ltdiv id="app-mensajes" class="app-mensajes grey lighten-1">
		&lt!--En esta linea ngFor nos va a permitir obtener los mensajes de la base de datos
		 que se han enviado del lado del usuario para poder visualizarlos y de igual forma se utiliza el pip
	 	 async para que se muestra la información sin basura -->
		&ltdiv *ngFor="let mensaje of _ls.mensajes | async">
	    &lt!--En la etiqueta span y en la etiqueta p, se estaran mostrando el nombre del usuario y
			el mensaje que esta enviando o recibiendo -->
     	&ltspan class="red darken-2 white-text">
	      {{ mensaje.nombre }}
	    &lt/span>
	    &ltp class="grey grey-text text-darken-3">
	      Q: {{ mensaje.mensaje }}
	    &lt/p>
	 	&lt/div>
	&lt/div>
&lt!--Este contenedor nos permite enviarle el mensaje al administrador-->
	&ltng-container *ngIf="_ls.user!='administrador'">
		&lt!--ngModel nos permite que todo lo que se esta enviando mediante el input, se va a almacenar
		en una variable llamada mensaje, la cuál va a ser utilizada en el código de javascript-->
	&ltinput [(ngModel)]="mensaje"
	        name="mensaje"
	        (keyup.enter)="enviar()"
	        placeholder="Deja tu mensaje..."
					class="grey darken-4 center white-text">
	&lt!--Con el metodo click que se esta utilizando en la etiqueta a, estamos indicando una llamada a
	una función que se encuentra en el javascript para enviar los mensajes a la base de datos-->
	&lta class="waves-effect waves-light btn-large red darken-4" (click)="enviar()">Enviar&lt/a>
	&lt/ng-container>
  &lt!--En este contenedor esta haciendo lo mismo que el anterior, pero en este caso son los Mensajes
  que estara enviando el administrador en respuesta a los chat de cada persona-->
	&ltng-container *ngIf="_ls.user=='administrador'">
		&ltinput [(ngModel)]="mensaje"
	        name="mensaje"
	        (keyup.enter)="enviarAdm()"
	        placeholder="Deja tu mensaje..."
					class="grey darken-4 center white-text">
		&lta class="waves-effect waves-light btn-large red darken-4" (click)="enviarAdm()">Enviar&lt/a>
	&lt/ng-container>
&lt/div>
&lt/div>
          </pre>
        </div>

        <div class="col l6 m12 s12">
          <h3 class="center white-text">Código TypeScript</h3>
          <h3 class="center white-text">Componente principal</h3>
          <pre class="language-markup">
export class AppComponent {
  constructor(public _ls:LoginService) { //AQUI SE INICIALIZA LA CLASE DEL SERVICIO
  }
  login(){
    //Se hace el llamado a la función login que se encuentra en el archivo service
  	this._ls.login();
  }
  logout(){
    //Se hace el llamado a la funcion logout que se encuentra en el archivo service
  	this._ls.logout();
  }
  loginAdministrador(){
    //Se hace el llamado a la funcion loginAdministrador que se encuentra en el archivo service
    this._ls.loginAdministrador();
  }
  logoutAdministrador(){
    //se hace el llamado a la funcion logoutAdministrador que se encuentra en el archivo service
    this._ls.logoutAdministrador();
  }
}
          </pre>
          <h3 class="center white-text">Componente del chat</h3>
          <pre class="language-markup">
/*En esta parte estamos utilizando el componente llamado chat para poder utilizar el javascript*/
export class ChatComponent implements OnInit {
  /*Aqui vamos a declarar las variables que vamos a utilizar*/
	mensaje:string="";
	elemento:any;
  uid='';
  chats;
  //Por medio de un constructor hacemos referencia al componente service.ts
  constructor(public _ls:LoginService) {
    if(this._ls.user!="administrador"){
      /*Se hace un llamado a la función cargar mensajes que se encuentra en el ts llamado service que
      nos sirve para cargar los mensajes*/
      this._ls.cargarMensajes().subscribe( ()=>{
       console.log("Mensajes cargados....");
       setTimeout( ()=>this.elemento.scrollTop=this.elemento.scrollHeight, 50);
      });
    }else if(this._ls.user="administrador"){
      /*Se llama a la función cargarChats que esta en service para poder visualizar todo las personas
      que se han logeado y dejado un mensaje*/
      this.chats=this._ls.cargarChats().subscribe( ()=>{
        console.log("Chats cargados...");
        console.log(this.chats);
      });
    }
  }
  ngOnInit() {
    /*Estamos mostrando los mensajes en el div llamado app-mensajes*/
  	this.elemento = document.getElementById("app-mensajes");
  }
  enviar(){
  	if(this.mensaje.length == 0){
  		//SI NO HAY NADA ESCRITO EN EL INPUT
  		return;
  	}
    /*Envia el mensaje que se localiza en el input del html*/
    this._ls.agregarMensaje(this.mensaje);
    //limpia el input y la variable mensaje para que pueda escribir un nuevo mensaje
  	this.mensaje="";
  }
  enviarAdm(){
    if(this.mensaje.length == 0){
    return;
    }
    //Envia el mensaje junto con el uid (identificador propio de cada usuario) a la función agregarMensajeAdm
    this._ls.agregarMensajeAdm(this.mensaje,this.uid);
    this.mensaje="";
  }
  consultar(uid){
    this.uid=uid;
    /*Carga los mensajes y los envia a la función cargarMsjUid pero ahora personalizadamente,
    dependiendo de el usuario que se haya seleccionado*/
    this._ls.cargarMsjUid(this.uid).subscribe( ()=>{
      setTimeout( ()=>this.elemento.scrollTop=this.elemento.scrollHeight, 50);
    });
  }
}
          </pre>
          <h3 class="center white-text">Componente del service</h3>
          <pre class="language-markup">
export class LoginService {
  user: any;
  mensajes;
  chats;
  //ALMACENA LAS CONVERSACIONES CON LOS DIFERENTES USUARIOS
  constructor(public db: AngularFireDatabase,
    public afAuth: AngularFireAuth) {
    //SE CHECA SI HAY UN USUARIO LOGEADO EN LOCALSTORAGE
    if( localStorage.getItem('user')){
      //MIENTRAS SEA DIFERENTE DE ADMINISTRADOR
      if(localStorage.getItem('user')!='administrador'){
        //SE OBTIENE DE LOCALSTORAGE Y SE ALMACENA EN LA VARIABLE USER
        this.user = JSON.parse(localStorage.getItem('user'));
        //SE ESTABLECE LA RUTA EN LA CUAL ESTARAN GUARDADOS LOS MENSAJES DEL USUARIO
        this.mensajes = db.list('/chats/'+this.user.user.uid);
      }else{
        this.user = localStorage.getItem('user');
      }
    }else{
      this.user = null;
    }
    console.log(this.user);
    }

  // AUTENTICACION CON GOOGLE
  login() {
  /*con esta linea de codigo estamos indicando que nos aparezca en un popUp la ventana en la
  cual podremos hacer el logeo con GOOGLE*/
  this.afAuth.auth.signInWithPopup(new firebase.auth.GoogleAuthProvider(),)
  .then(result=>{
  /*con esta linea de codigo estamos indicando que cuando un usuario ya haya registrado
  una visita al sitio, pueda guardarse su nombre de usuaurio y su key para poder mostrar
  el chat que ha tenido*/
  this.db.list('/usuarios').update(result.user.uid,{
    uid:result.user.uid,
    nombre:result.user.displayName
  });
  this.user=result;
  //UNA VEZ QUE EL USUARIO SE AUTENTICA Y SE OBTIENEN SUS DATOS SE ALMACENAN EN LOCALSTORAGE
  localStorage.setItem('user', JSON.stringify(result) );
  });
  }

  /*función del boton del logout*/
  logout() {
    /*Aqui estamos indicando que por medio de la variable localStorage y la propiedad removeItem
    lo que contenga user, en este caso el nombre del usuario, pasara a null*/
    localStorage.removeItem('user');
    this.user = null;
    /*con la funcion signOut estamos cerrando la sesión del usuario y nos mandara un mensaje en la
    consola que nos indique que la sesión fue cerrada exitosamente */
    this.afAuth.auth.signOut().then(function(){
      console.log("sign-out successful");
    });
  }
  agregarMensaje(text:string){
    /*con la variable mensajes que arriba inicializamos en el constructor e indicamos la ruta donde
    la información de esa variable estara almacenada en la base de datos, ahora estamos indicando la
    estructura que va a tener en los archivos JSON cada mensaje*/
    let mensaje={
      nombre:  this.user.user.displayName,
      mensaje:text
    }
    //Aqui estamos agregando el mensaje a la base de datos
    this.mensajes.push(mensaje);
  }

  agregarMensajeAdm(text:string, uid){
    /*En esta linea estamos indicando el formato que va a tener el documento JSON al momento de guardar
    el mensaje del administrador hacia el usurio*/
    let mensaje={
      nombre: 'administrador',
      mensaje:text
    }
    /*En esta linea de código estamos indicando la ruta donde se almacenara el mensaje y despues con el
    metodo push lo estamos almacenando en firebase (En este caso, estamos indicando la ruta donde el
    mensaje personalizado debe de ir ya que cada documento JSON es un usurio y le indicamos en que
    documento JSON se tiene que almacenar dependiendo del usuario al cuál esta contestando)*/
    this.db.list('/chats/'+uid).push(mensaje);
  }

  /*Con esta función estamos mostrando en pantalla los mensajes que el usuario ha enviado y de igual
  forma los mensajes que el administrador le ha enviado*/
  cargarMensajes(){
    this.mensajes = this.db.list('/chats/'+this.user.user.uid,{
    query: {
    //Se ordenan por clave para que los mensajes mas recientes aparezcan al ultimo
    orderByKey:true
    }
    });
    return this.mensajes;
  }
  /*Con esta función estas mostrando individualmente cada mensaje que le ha enviado cada usuario al
  administrador y de igual forma los que el administrador le ha enviado al usuario*/
  cargarMsjUid(uid){
    this.mensajes = this.db.list('/chats/'+uid,{
      query: {
        //Se ordenan por clave para que los mensajes mas recientes aparezcan al ultimo
        orderByKey:true
      }
    });
    return this.mensajes;
  }
  /*Con esta funcion, estamos cargando todos las personas que han dejado mensajes para que los pueda
  visualizar el administrador individualmente*/
  cargarChats(){
    this.chats = this.db.list('/usuarios/',{
      query:{
        orderByKey:true
      }
    });
    return this.chats;
  }
  //Login del administrador
  loginAdministrador(){
    this.logout();
    this.user="administrador"
    localStorage.setItem('user',this.user);
  }
  //Logout del administrador
  logoutAdministrador(){
    console.log("adm deslogueado");
    localStorage.removeItem('user');
    this.user=null;
  }
}
          </pre>
        </div>
      </div>

      <!------------------Scripts------------------>
      <script type="text/javascript" src="./js/jquery-2.1.4.min.js"></script>
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/js/materialize.min.js"></script>
    	<script type="text/javascript" src="./js/app.js"></script>
  </body>
</html>
